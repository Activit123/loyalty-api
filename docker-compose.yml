# Folosim cea mai recentă versiune a specificației Compose
version: '3.9'

services:
  # Serviciul pentru backend-ul Spring Boot
  backend:
    # Construiește imaginea folosind Dockerfile-ul din directorul curent
    build:
      context: .
      dockerfile: Dockerfile

    # Numele containerului pentru a-l identifica ușor
    container_name: barlog-backend

    # 'backend' va porni doar după ce 'database' este gata
    depends_on:
      - database

    # Expune portul 8090 al containerului pe portul 8090 al mașinii gazdă
    # Am folosit 8090 conform application.properties
    ports:
      - "8090:8090"

    # Aici definim toate variabilele de mediu care suprascriu application.properties
    environment:
      # --- Configurare Bază de Date ---
      # Folosim numele serviciului 'database' ca host în rețeaua Docker
      - SPRING_DATASOURCE_URL=jdbc:postgresql://database:5432/barlogdb
      - SPRING_DATASOURCE_USERNAME=barloguser
      - SPRING_DATASOURCE_PASSWORD=barlogpassword

      # --- Configurare Securitate ---
      - APPLICATION_SECURITY_JWT_SECRET-KEY=${JWT_SECRET_KEY}
      - ADMIN_CREATION_SECRET-KEY=${ADMIN_SECRET_KEY}

      # --- Configurare Google OAuth2 ---
      - SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT-ID=${GOOGLE_CLIENT_ID}
      - SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT-SECRET=${GOOGLE_CLIENT_SECRET}

  # Serviciul pentru baza de date PostgreSQL
  database:
    image: postgres:15
    container_name: barlog-postgres

    # Numele host-ului în rețeaua Docker va fi 'database'
    hostname: database

    # Expunem portul bazei de date pe mașina gazdă pentru debugging (opțional)
    ports:
      - "5433:5432"

    # Variabile de mediu pentru a inițializa baza de date
    environment:
      - POSTGRES_USER=barloguser
      - POSTGRES_PASSWORD=barlogpassword
      - POSTGRES_DB=barlogdb

    # Volum pentru a asigura persistența datelor
    volumes:
      - barlog-db-data:/var/lib/postgresql/data

# Definirea volumului numit
volumes:
  barlog-db-data: